<script>
  // ===============================================================
  // ARCHIVO: JS_App.html (CORREGIDO)
  // ROL: Lógica principal de la aplicación, navegación y utilidades.
  // ===============================================================

  // --- ESTADO Y VARIABLES GLOBALES DE LA APLICACIÓN ---
  let configData = {};
  let initialEquipmentData = null; // Variable para guardar los datos precargados
  let appState = {
      dashboardLoaded: false,
      equiposLoaded: false,
      configLoaded: false,
      currentPage: 1,
      currentItemOriginalState: null
  };
  
  // Mapeos de columnas para la UI (Inglés) y el Backend (Español)
  const ORDEN_COLUMNAS_EN = ['Serial', 'Item Name', 'Brand', 'Ownership', 'Date Added', 'Agent', 'Status', 'Floor', 'Mac Lan', 'Mac Wifi', 'Acta Firmada'];
  const COLUMN_MAP_EN_TO_ES = {
      'Serial': 'Serial',
      'Item Name': 'Nombre del elemento',
      'Brand': 'Marca',
      'Ownership': 'Propiedad',
      'Date Added': 'Fecha de Ingreso',
      'Agent': 'Agente',
      'Status': 'Estado',
      'Floor': 'Piso',
      'Mac Lan': 'Mac Lan',
      'Mac Wifi': 'Mac Wifi',
      'Acta Firmada': 'Acta Firmada' 
  };
  const COLUMNA_ACTA_FIRMADA_ES = "Acta Firmada";

  // Elementos comunes de la UI
  const mainTitle = document.getElementById('main-title');
  const navLinks = document.querySelectorAll('#sidebar-nav a');
  const views = document.querySelectorAll('.view-container');

  // --- INICIALIZACIÓN DE LA APLICACIÓN ---
  document.addEventListener("DOMContentLoaded", () => {
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(initializeApp);
  });

  function initializeApp() {
    google.script.run
      .withSuccessHandler(data => {
          configData = data;
          populateFilterDropdowns();
          populateReportFilter();
          navigateTo('dashboard');
          google.script.run
            .withSuccessHandler(equipmentResponse => {
              console.log("Equipment data pre-loaded successfully.");
              initialEquipmentData = equipmentResponse;
            })
            .withFailureHandler(error => console.error("Pre-loading failed:", error))
            .getFilteredEquipment({ hoja: 'All Locations', pagina: 1, filtros: {}, itemsPorPagina: 30 });
      })
      .withFailureHandler(mostrarError)
      .getConfigurationLists();
    
    const menuToggle = document.getElementById('menu-toggle');
    const overlay = document.getElementById('app-overlay');
    menuToggle.addEventListener('click', () => toggleSidebar());
    overlay.addEventListener('click', () => toggleSidebar(false));
  }

  // --- NAVEGACIÓN Y MANEJO DE VISTAS ---
  function navigateTo(viewName) {
      views.forEach(view => view.classList.add('hidden'));
      navLinks.forEach(link => link.classList.remove('active'));
      
      document.getElementById(`view-${viewName}`).classList.remove('hidden');
      const navLink = document.getElementById(`nav-${viewName}`);
      navLink.classList.add('active');
      mainTitle.textContent = navLink.querySelector('span').textContent;
      
      if (viewName === 'dashboard' && !appState.dashboardLoaded) loadDashboardData();
      if (viewName === 'equipos' && !appState.equiposLoaded) cargarEquipos();
      if (viewName === 'config' && !appState.configLoaded) loadConfigData();

      if (window.innerWidth <= 992) {
        toggleSidebar(false);
      }
  }

  function toggleSidebar(forceOpen) {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('app-overlay');
    const isOpen = sidebar.classList.contains('open');

    if (typeof forceOpen === 'boolean' ? forceOpen : !isOpen) {
      sidebar.classList.add('open');
      overlay.classList.remove('hidden');
    } else {
      sidebar.classList.remove('open');
      overlay.classList.add('hidden');
    }
  }

  // --- FUNCIONES DE UTILIDAD ---
  
  /**
   * Muestra una notificación (toast) en la esquina superior derecha.
   * INCLUYE: Estilos aplicados directamente vía JS para garantizar la visualización.
   * @param {string} message El mensaje a mostrar.
   * @param {string} type El tipo de notificación ('success' o 'error').
   */
  function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if (!container) {
        console.error("El contenedor de notificaciones no fue encontrado.");
        return;
    }

    const toast = document.createElement('div');
    
    // Aplicar estilos directamente para evitar problemas de carga de CSS
    Object.assign(toast.style, {
        display: 'flex',
        alignItems: 'center',
        gap: '15px',
        padding: '15px 20px',
        borderRadius: '8px',
        backgroundColor: '#2a3654', // var(--card-bg-solid)
        color: '#e0e0e0', // var(--text-primary)
        border: '1px solid rgba(85, 124, 248, 0.2)', // var(--card-border-color)
        boxShadow: '0 4px 20px rgba(0, 0, 0, 0.3)',
        minWidth: '300px',
        animation: 'toast-in 0.5s ease',
        fontFamily: 'Inter, sans-serif'
    });

    const icon = document.createElement('i');
    icon.style.fontSize = '1.5rem';

    if (type === 'success') {
        toast.style.borderLeft = '5px solid #2dd4bf'; // var(--success-color)
        icon.className = 'fas fa-check-circle';
        icon.style.color = '#2dd4bf';
    } else {
        toast.style.borderLeft = '5px solid #f472b6'; // var(--danger-color)
        icon.className = 'fas fa-times-circle';
        icon.style.color = '#f472b6';
    }
    
    const text = document.createElement('span');
    text.textContent = message;

    toast.appendChild(icon);
    toast.appendChild(text);
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'toast-out 0.5s forwards';
      toast.addEventListener('animationend', () => toast.remove());
    }, 4000);
  }

  function mostrarError(error) {
    console.error('Error de Google Script:', error);
    showToast('Ocurrió un error: ' + error.message, 'error');
    document.querySelectorAll('.loader-container').forEach(loader => loader.classList.add('hidden'));
  }
</script>
