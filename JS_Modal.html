<script>
  // ===============================================================
  // ARCHIVO: JS_Modal.html (Versión con Modal de Reenvío Personalizado)
  // ROL: Lógica para el modal de creación, edición y subida de actas.
  // ===============================================================

  const modal = document.getElementById('modal');
  let stockEquipment = [];
  let currentItemForModal = null;
  let swapChoices = null; // Variable para la instancia de Choices.js

  function abrirModal() {
      modal.classList.remove('hidden');
      setTimeout(() => modal.classList.add('visible'), 10);
  }

  function cerrarModal() {
      if (swapChoices) {
          swapChoices.destroy();
          swapChoices = null;
      }
      modal.classList.remove('visible');
      setTimeout(() => modal.classList.add('hidden'), 300);
  }
  
  function switchModalTab(tabName) {
      document.querySelectorAll('.modal-tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(`modal-body-${tabName}`).classList.remove('hidden');
      document.getElementById(`tab-${tabName}`).classList.add('active');
  }

  // --- FLUJO 1: AGREGAR NUEVO EQUIPO ---

  function abrirModalAgregar() {
      switchModalTab('detalles');
      document.getElementById('modal-tabs').classList.remove('hidden');
      document.getElementById('tab-historial').classList.add('hidden');
      document.getElementById('modal-title').innerText = "Add New Item to Stock";
      document.getElementById('modal-body-detalles').innerHTML = generarCamposDeFormulario({}, 'newItem');
      
      const footer = document.getElementById('modal-footer');
      footer.innerHTML = `
        <button class="button cancel-btn" onclick="cerrarModal()">Cancelar</button>
        <button class="button" onclick="ejecutarGuardarNuevo()">Guardar</button>
      `;
      abrirModal();
  }

  function ejecutarGuardarNuevo() {
    const datosParaEnviar = {};
    const fieldsForNewItem = ORDEN_COLUMNAS_EN.filter(c => !['Agent', 'Status', 'Floor', 'Date Added', 'Acta Firmada'].includes(c));
    
    fieldsForNewItem.forEach(c_en => {
        const element = document.getElementById(`form-new-${c_en.replace(/ /g, '')}`);
        if (element) datosParaEnviar[COLUMN_MAP_EN_TO_ES[c_en]] = element.value;
    });

    if (!datosParaEnviar[COLUMN_MAP_EN_TO_ES['Serial']]) {
      showToast('Serial number is required.', 'error');
      return;
    }

    cerrarModal();
    google.script.run.withSuccessHandler(respuesta => {
      if (respuesta.success) {
        showToast('Nuevo equipo agregado al stock correctamente.', 'success');
        cargarEquipos();
        appState.dashboardLoaded = false;
      } else {
        showToast(respuesta.message || 'Ocurrió un error al agregar el equipo.', 'error');
      }
    }).withFailureHandler(mostrarError).agregarEquipo(datosParaEnviar);
  }

  // --- FLUJO 2: ASIGNAR EQUIPO DESDE STOCK ---

  function abrirModalAsignar() {
    google.script.run
      .withSuccessHandler(stockList => {
        if (!stockList || stockList.length === 0) {
          showToast("No hay equipos disponibles en Stock para asignar.", "error");
          return;
        }
        
        document.getElementById('modal-tabs').classList.add('hidden');
        document.getElementById('modal-title').innerText = "Asignar Equipo desde Stock";

        let stockOptions = stockList.map(eq => `<option value="${eq.serial}">${eq.nombre} (${eq.serial})</option>`).join('');
        let floorOptions = (configData.pisos || []).map(p => `<option value="${p}">${p}</option>`).join('');

        const modalBody = document.getElementById('modal-body-detalles');
        
        modalBody.innerHTML = `
          <div class="form-grid">
            <div class="form-field full-width">
              <label for="form-assign-item">Equipo a Asignar</label>
              <div class="input-with-icon">
                <i class="fas fa-laptop"></i>
                <select id="form-assign-item">
                  <option value="">Seleccione un equipo...</option>
                  ${stockOptions}
                </select>
              </div>
            </div>
            <div class="form-field">
              <label for="form-assign-agent">Asignar a Agente (Nombre Completo)</label>
              <div class="input-with-icon">
                <i class="fas fa-user"></i>
                <input type="text" id="form-assign-agent" placeholder="Nombre completo...">
              </div>
            </div>
            <div class="form-field">
              <label for="form-assign-id">Cédula del Agente</label>
              <div class="input-with-icon">
                <i class="fas fa-id-card"></i>
                <input type="text" id="form-assign-id" placeholder="Número de cédula...">
              </div>
            </div>
            <div class="form-field">
              <label for="form-assign-email">Correo Electrónico del Agente</label>
              <div class="input-with-icon">
                <i class="fas fa-envelope"></i>
                <input type="text" id="form-assign-email" placeholder="correo@ejemplo.com">
              </div>
            </div>
            <div class="form-field">
              <label for="form-assign-floor">Piso</label>
              <div class="input-with-icon">
                <i class="fas fa-building"></i>
                <select id="form-assign-floor">
                  <option value="">Seleccione un piso...</option>
                  ${floorOptions}
                </select>
              </div>
            </div>
          </div>
        `;
        
        const footer = document.getElementById('modal-footer');
        footer.innerHTML = `
          <button class="button cancel-btn" onclick="cerrarModal()">Cancelar</button>
          <button class="button" onclick="ejecutarAsignar()">Asignar y Generar Acta</button>
        `;

        switchModalTab('detalles'); 
        abrirModal();
      })
      .withFailureHandler(mostrarError)
      .getStockEquipment();
  }

  function ejecutarAsignar() {
    const assignmentDetails = {
      serial: document.getElementById('form-assign-item').value,
      agent: document.getElementById('form-assign-agent').value,
      agentId: document.getElementById('form-assign-id').value,
      agentEmail: document.getElementById('form-assign-email').value,
      floor: document.getElementById('form-assign-floor').value
    };

    if (!assignmentDetails.serial || !assignmentDetails.agent || !assignmentDetails.floor || !assignmentDetails.agentId || !assignmentDetails.agentEmail) {
      showToast('Por favor, llene todos los campos para generar el acta.', 'error');
      return;
    }

    cerrarModal();
    google.script.run
      .withSuccessHandler(response => {
        if (response.success) {
          showToast('Equipo asignado y acta generada correctamente.', 'success');
          cargarEquipos();
          appState.dashboardLoaded = false;
        } else {
          showToast(response.message || 'Ocurrió un error al asignar el equipo.', 'error');
        }
      })
      .withFailureHandler(mostrarError)
      .assignItemFromStock(assignmentDetails);
  }

  // --- FLUJO 3: EDITAR EQUIPO EXISTENTE ---

  function abrirModalEditar(idFila, sheetName, serial) {
      currentItemForModal = datosPaginados.find(d => d.idFila === idFila && d.sheetName === sheetName);
      if (!currentItemForModal) {
          showToast('Error: Equipo no encontrado. Por favor, refresque la página.', 'error');
          return; 
      }
      
      appState.currentItemOriginalState = currentItemForModal.Estado;
      
      if (appState.currentItemOriginalState === 'Asignado') {
        google.script.run.withSuccessHandler(list => {
          stockEquipment = list;
          showEditModal(currentItemForModal, idFila, sheetName, serial);
        }).withFailureHandler(mostrarError).getStockEquipment();
      } else {
        stockEquipment = [];
        showEditModal(currentItemForModal, idFila, sheetName, serial);
      }
  }

  function showEditModal(item, idFila, sheetName, serial) {
      document.getElementById('modal-tabs').classList.remove('hidden');
      document.getElementById('tab-historial').classList.remove('hidden');
      switchModalTab('detalles');
      
      document.getElementById('modal-title').innerText = `Editando: ${item[COLUMN_MAP_EN_TO_ES['Item Name']] || 'Equipo'}`;
      document.getElementById('modal-body-detalles').innerHTML = generarCamposDeFormulario(item, 'edit');
      
      document.getElementById('form-edit-Status')?.addEventListener('change', handleStatusChange);

      const footer = document.getElementById('modal-footer');
      footer.innerHTML = `
        <button class="button cancel-btn" onclick="cerrarModal()">Cancelar</button>
        <button class="button" onclick="ejecutarActualizar(${idFila}, '${sheetName}')">Actualizar</button>
      `;
      
      const historialList = document.getElementById('historial-list');
      const historialLoader = document.getElementById('historial-loader');
      historialList.innerHTML = '';
      historialLoader.classList.remove('hidden');
      google.script.run
          .withSuccessHandler(history => {
              historialLoader.classList.add('hidden');
              if(history && history.length > 0){
                  history.forEach(entry => historialList.innerHTML += `<li><span class="activity-time">${entry[0]}</span><span class="activity-desc"><strong>${entry[2]}:</strong> ${entry[3]}</span></li>`);
              } else {
                  historialList.innerHTML = '<li>No hay historial para este equipo.</li>';
              }
          })
          .withFailureHandler(mostrarError)
          .getIndividualHistory(serial);

      abrirModal();
  }

  function ejecutarActualizar(idFila, sheetName) {
    const datosParaEnviar = {};
    ORDEN_COLUMNAS_EN.forEach(c_en => {
        const element = document.getElementById(`form-edit-${c_en.replace(/ /g, '')}`);
        if(element) datosParaEnviar[COLUMN_MAP_EN_TO_ES[c_en]] = element.value;
    });
    
    let swapInfo = null;
    let returnInfo = null;
    let reassignmentInfo = null;

    if (document.getElementById('swap-section')) {
      const motivo = document.getElementById('motivo-cambio').value;
      const nuevoSerial = document.getElementById('nuevo-equipo-serial').value;
      if (!motivo) {
        showToast('El motivo del cambio es requerido para realizar un reemplazo.', 'error');
        return;
      }
      swapInfo = { motivoCambio: motivo, nuevoEquipoSerial: nuevoSerial };
      if (nuevoSerial) {
        swapInfo.agentId = document.getElementById('swap-agent-id').value;
        swapInfo.agentEmail = document.getElementById('swap-agent-email').value;
        if (!swapInfo.agentId || !swapInfo.agentEmail) {
          showToast('La Cédula y el Correo son requeridos para generar el acta del nuevo equipo.', 'error');
          return;
        }
      }
    }

    if (document.getElementById('return-section')) {
        returnInfo = {
            returnEmail: document.getElementById('return-email').value
        };
        if (!returnInfo.returnEmail) {
            showToast('El correo para la notificación de devolución es requerido.', 'error');
            return;
        }
    }

    const agentField = document.getElementById('form-edit-Agent');
    if (agentField) {
      const originalAgent = currentItemForModal[COLUMN_MAP_EN_TO_ES['Agent']];
      const newAgent = agentField.value;
      if (originalAgent !== newAgent) {
        const newAgentId = prompt(`Se está reasignando el equipo a "${newAgent}".\nPor favor, ingrese la CÉDULA del nuevo agente para generar el acta:`);
        const newAgentEmail = prompt(`Ahora ingrese el CORREO de "${newAgent}" para enviar el acta:`);
        if (newAgentId && newAgentEmail) {
          reassignmentInfo = {
            agent: newAgent,
            agentId: newAgentId,
            agentEmail: newAgentEmail
          };
        } else {
          showToast('Reasignación cancelada. Cédula y correo son necesarios.', 'error');
          return;
        }
      }
    }

    cerrarModal();
    google.script.run
      .withSuccessHandler(respuesta => {
        if (respuesta.success) {
            showToast('Equipo actualizado correctamente. Se han procesado los cambios y generado las actas necesarias.', 'success');
            cargarEquipos(appState.currentPage);
            appState.dashboardLoaded = false;
        } else {
            showToast(respuesta.message || 'Ocurrió un error al actualizar el equipo.', 'error');
        }
      })
      .withFailureHandler(mostrarError)
      .guardarCambiosEquipo(sheetName, idFila, datosParaEnviar, swapInfo, returnInfo, reassignmentInfo);
  }

  // --- FLUJO 4: SUBIR ACTA ---

  function abrirModalSubirActa(idFila, sheetName) {
      currentItemForModal = { idFila, sheetName };

      document.getElementById('modal-tabs').classList.add('hidden');
      document.getElementById('modal-title').innerText = "Subir Acta Firmada";
      
      const modalBody = document.getElementById('modal-body-detalles');
      modalBody.innerHTML = `
          <div class="form-field">
              <label for="form-upload-file">Seleccione el archivo PDF del acta</label>
              <input type="file" id="form-upload-file" accept=".pdf">
              <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">El archivo se guardará en Google Drive y el enlace se añadirá al registro del equipo.</p>
          </div>
      `;
      
      const footer = document.getElementById('modal-footer');
      footer.innerHTML = `
          <button class="button cancel-btn" onclick="cerrarModal()">Cancelar</button>
          <button class="button" onclick="ejecutarSubirActa()">Subir y Guardar</button>
      `;

      switchModalTab('detalles');
      abrirModal();
  }
  
  function ejecutarSubirActa() {
      const fileInput = document.getElementById('form-upload-file');
      const file = fileInput.files[0];

      if (!file) {
          showToast('Por favor, seleccione un archivo.', 'error');
          return;
      }
      if (file.type !== "application/pdf") {
          showToast('Solo se permiten archivos PDF.', 'error');
          return;
      }

      cerrarModal();
      document.getElementById('loader-equipos').classList.remove('hidden');
      document.getElementById('tabla-inventario').classList.add('hidden');

      const reader = new FileReader();
      reader.onload = function(e) {
          const fileData = {
              fileName: file.name,
              mimeType: file.type,
              data: e.target.result.split(',')[1]
          };
          
          const { idFila, sheetName } = currentItemForModal;

          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      showToast('Acta subida y enlazada correctamente.', 'success');
                      cargarEquipos(appState.currentPage); 
                  } else {
                     showToast(response.message || 'Ocurrió un error al subir el acta.', 'error');
                     document.getElementById('loader-equipos').classList.add('hidden');
                     document.getElementById('tabla-inventario').classList.remove('hidden');
                  }
              })
              .withFailureHandler(mostrarError)
              .uploadSignedCertificate(idFila, sheetName, fileData);
      };
      reader.readAsDataURL(file);
  }

  // --- INICIO DE LA MODIFICACIÓN: FLUJO 5: REENVIAR ACTA ---
  function abrirModalParaReenvio(idFila, sheetName, agentName) {
      document.getElementById('modal-tabs').classList.add('hidden');
      document.getElementById('modal-title').innerText = `Reenviar Acta a ${agentName}`;
      
      const modalBody = document.getElementById('modal-body-detalles');
      modalBody.innerHTML = `
          <p class="mb-4" style="color: var(--text-secondary);">Confirme los datos del agente para reenviar el acta de entrega del equipo.</p>
          <div class="form-grid">
              <div class="form-field">
                  <label for="form-resend-id">Cédula del Agente</label>
                  <input type="text" id="form-resend-id" placeholder="Número de cédula...">
              </div>
              <div class="form-field">
                  <label for="form-resend-email">Correo Electrónico del Agente</label>
                  <input type="text" id="form-resend-email" placeholder="correo@ejemplo.com">
              </div>
          </div>
      `;
      
      const footer = document.getElementById('modal-footer');
      footer.innerHTML = `
          <button class="button cancel-btn" onclick="cerrarModal()">Cancelar</button>
          <button class="button" onclick="ejecutarReenvio(${idFila}, '${sheetName}')">Enviar Acta</button>
      `;

      switchModalTab('detalles');
      abrirModal();
  }

  function ejecutarReenvio(idFila, sheetName) {
      const agentId = document.getElementById('form-resend-id').value;
      const agentEmail = document.getElementById('form-resend-email').value;

      if (!agentId || !agentEmail) {
          showToast('La cédula y el correo son obligatorios.', 'error');
          return;
      }
      
      cerrarModal();
      google.script.run
          .withSuccessHandler(response => {
              if (response.success) {
                  showToast(response.message, 'success');
              } else {
                  showToast(response.message, 'error');
              }
          })
          .withFailureHandler(mostrarError)
          .reenviarActa(sheetName, idFila, agentId, agentEmail);
  }
  // --- FIN DE LA MODIFICACIÓN ---


  // --- FUNCIONES COMPARTIDAS DEL MODAL ---
  function handleStatusChange() {
      const nuevoEstado = document.getElementById('form-edit-Status').value;
      const esDevolucion = appState.currentItemOriginalState === 'Asignado' && ['Stock', 'Disponible', 'En Reparación', 'De Baja'].includes(nuevoEstado);
      const actaUrl = currentItemForModal[COLUMNA_ACTA_FIRMADA_ES];

      if (document.getElementById('swap-section')) document.getElementById('swap-section').remove();
      if (document.getElementById('return-section')) document.getElementById('return-section').remove();

      if (esDevolucion) {
          handleSwapUI();
          const nuevoSerialSelect = document.getElementById('nuevo-equipo-serial');
          if (actaUrl && (!nuevoSerialSelect || !nuevoSerialSelect.value)) {
              handleReturnUI();
          }
      }
  }

  function handleSwapUI() {
      const newSection = document.createElement('div');
      newSection.id = 'swap-section';
      newSection.innerHTML = `
          <h4>Reemplazo de Equipo</h4>
          <div class="form-field">
              <label for="motivo-cambio">Motivo del Cambio (requerido)</label>
              <textarea id="motivo-cambio"></textarea>
          </div>
          <div class="form-field">
              <label for="nuevo-equipo-serial">Asignar Nuevo Equipo desde Stock (opcional)</label>
              <select id="nuevo-equipo-serial">
                  <option value="">No asignar reemplazo</option>
                  ${stockEquipment.map(eq => `<option value="${eq.serial}">${eq.nombre} (${eq.serial})</option>`).join('')}
              </select>
          </div>
          <div id="swap-acta-fields" class="form-grid hidden">
              <div class="form-field">
                <label for="swap-agent-id">Cédula del Agente (para el acta)</label>
                <input type="text" id="swap-agent-id" placeholder="Cédula para el nuevo equipo...">
              </div>
              <div class="form-field">
                <label for="swap-agent-email">Correo del Agente (para el acta)</label>
                <input type="text" id="swap-agent-email" placeholder="Correo para el nuevo equipo...">
              </div>
          </div>
      `;
      document.getElementById('modal-body-detalles').appendChild(newSection);

      const selectElement = document.getElementById('nuevo-equipo-serial');
      if (selectElement) {
          if (swapChoices) swapChoices.destroy();
          swapChoices = new Choices(selectElement, {
              searchEnabled: true,
              itemSelectText: 'Seleccionar',
              placeholder: true,
              placeholderValue: 'Escribe para buscar equipo...',
              allowHTML: false,
          });
          selectElement.addEventListener('change', (event) => toggleSwapActaFields(event.target.value));
      }
  }

  function handleReturnUI() {
      if (document.getElementById('return-section')) return;
      const newSection = document.createElement('div');
      newSection.id = 'return-section';
      newSection.innerHTML = `
          <h4>Notificación de Devolución</h4>
          <div class="form-field">
              <label for="return-email">Enviar acta existente para firma de devolución a:</label>
              <input type="text" id="return-email" placeholder="Ingrese uno o más correos separados por coma...">
          </div>
      `;
      const swapSection = document.getElementById('swap-section');
      if (swapSection) {
          swapSection.insertAdjacentElement('afterend', newSection);
      } else {
          document.getElementById('modal-body-detalles').appendChild(newSection);
      }
  }

  function toggleSwapActaFields(selectedValue) {
    document.getElementById('swap-acta-fields').classList.toggle('hidden', !selectedValue);
    if (!selectedValue && currentItemForModal[COLUMNA_ACTA_FIRMADA_ES]) {
        handleReturnUI();
    } else if (document.getElementById('return-section')) {
        document.getElementById('return-section').remove();
    }
  }
  
  function generarCamposDeFormulario(item = {}, formType = 'edit') {
      const fieldsToExclude = (formType === 'newItem') ? ['Agent', 'Status', 'Floor', 'Date Added', 'Acta Firmada'] : ['Date Added', 'Acta Firmada'];
      
      let formHTML = '<div class="form-grid">';
      
      formHTML += ORDEN_COLUMNAS_EN.map(c_en => {
          if (fieldsToExclude.includes(c_en) && formType === 'newItem') return '';
          if (c_en === 'Acta Firmada') return '';

          const c_es = COLUMN_MAP_EN_TO_ES[c_en];
          const valor = item[c_es] || '';
          const id = `form-${formType}-${c_en.replace(/ /g, '')}`;
          let fieldHTML = '';
          let fullWidthClass = (['Serial', 'Item Name', 'Agent'].includes(c_en)) ? 'full-width' : '';

          if (c_en === 'Status') {
              fieldHTML = `<select id="${id}">${(configData.estados || []).map(e => `<option value="${e}" ${valor === e ? 'selected' : ''}>${e}</option>`).join('')}</select>`;
          } else if (c_en === 'Floor') {
              fieldHTML = `<select id="${id}" ${item.Estado === 'Stock' || !item.Estado ? 'disabled' : ''}><option value="" ${!valor ? 'selected' : ''}>N/A (Stock)</option>${(configData.pisos || []).map(p => `<option value="${p}" ${String(valor) === String(p) ? 'selected' : ''}>${p}</option>`).join('')}</select>`;
          } else if (c_en === 'Brand') {
              fieldHTML = `<select id="${id}"><option value="">Seleccione una marca</option>${(configData.marcas || []).map(m => `<option value="${m}" ${valor === m ? 'selected' : ''}>${m}</option>`).join('')}</select>`;
          } else if (c_en === 'Ownership') {
              fieldHTML = `<select id="${id}"><option value="">Seleccione una propiedad</option>${(configData.propiedades || []).map(p => `<option value="${p}" ${valor === p ? 'selected' : ''}>${p}</option>`).join('')}</select>`;
          } else {
              const isReadOnly = (c_en === 'Date Added' && valor) || (c_en === 'Agent' && item.Estado !== 'Asignado' && formType === 'edit');
              const displayValue = (c_en === 'Date Added' && valor) ? new Date(valor).toLocaleDateString('es-CO') : valor;
              fieldHTML = `<input type="text" id="${id}" value="${displayValue}" ${isReadOnly ? 'readonly' : ''}>`;
          }
          return `<div class="form-field ${fullWidthClass}"><label for="${id}">${c_en}</label>${fieldHTML}</div>`;
      }).join('');

      formHTML += '</div>';
      return formHTML;
  }
</script>
